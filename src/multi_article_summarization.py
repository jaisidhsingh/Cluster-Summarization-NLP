# -*- coding: utf-8 -*-
"""Multi-Article Summarization.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1bDomoaz8AfavNVphcSEaV4yMHHx5MEMe

# Multi-Article Summarization Using Clustering Algorithms
"""

import math
import nltk
import warnings
from sklearn.decomposition import PCA
from sklearn.manifold import TSNE
import matplotlib.pyplot as plt
import numpy as np
from sentence_transformers import SentenceTransformer
from sklearn.cluster import AgglomerativeClustering, DBSCAN
import sklearn
from transformers import BartTokenizer, BartForConditionalGeneration
import transformers
import torch

nltk.download('punkt')
nltk.download('wordnet')

from nltk.tokenize import sent_tokenize, word_tokenize

warnings.filterwarnings("ignore")

embedding_model = SentenceTransformer('paraphrase-MiniLM-L6-v2')

summarization_tokenizer = BartTokenizer.from_pretrained(
    'facebook/bart-large-cnn')
summarization_model = BartForConditionalGeneration.from_pretrained(
    'facebook/bart-large-cnn')


def make_data(articles):
    sentences = []
    words = []

    for item in articles:
        tokenized_article = sent_tokenize(item)
        for sentence in tokenized_article:
            word_tokens = word_tokenize(sentence)
            for token in word_tokens:
                words.append(token)
            sentences.append(sentence)
    sentences, words = np.array(sentences), np.array(words)
    return sentences, words


def sentence2embedding(sentences_array, model):
    return model.encode(sentences_array)


def bart_summarize(
    text,
    model,
    tokenizer,
    device,
    num_beams=4,
    length_penalty=2.0,
    max_length=200,
    min_length=50,
    no_repeat_ngram_size=3,
):

    text = text.replace('\n', '')
    text_input_ids = tokenizer.batch_encode_plus(
        [text], return_tensors='pt', max_length=1024)['input_ids'].to(device)
    summary_ids = model.generate(text_input_ids, num_beams=int(num_beams), length_penalty=float(
        length_penalty), max_length=int(max_length), min_length=int(min_length), no_repeat_ngram_size=int(no_repeat_ngram_size))
    summary_txt = tokenizer.decode(
        summary_ids.squeeze(), skip_special_tokens=True)
    return summary_txt


class ClusterSentenceEmbeddings():
    def __init__(self, clustering_algorithm, embeddings, sentences, words, num_articles):
        self.num_articles = num_articles
        self.embeddings = embeddings
        self.sentences = sentences
        self.words = words
        self.clustering = clustering_algorithm.fit(self.embeddings)

    def cluster_outputs(self):
        outputs = {
            'num_clusters': self.clustering.n_clusters_,
            'labels': self.clustering.labels_,
            'components': self.clustering.n_connected_components_,
            'distances': self.clustering.distances_,
            'exp_sentences_per_cluster': math.ceil(
                len(self.sentences)/self.clustering.n_clusters_
            ),  # using pigeonhole principle formula for expectated number of pigeons per hole.
            'exp_words_per_cluster': math.ceil(
                len(self.words)/self.clustering.n_clusters_
            ),  # using pigeonhole principle formula for expected nu,ber of pigeons per hole.
        }
        return outputs

    def visualize_outputs(self, method='tsne', dims=2):

        if method == 'tsne':
            tSNE = TSNE(n_components=dims, learning_rate='auto', init='random')
            projected_embeddings = np.array(
                tSNE.fit_transform(self.embeddings))

            cluster_outputs = self.cluster_outputs()

            indiv_clusters = []
            for label in range(cluster_outputs['num_clusters']):
                indiv_clusters.append(projected_embeddings[
                    cluster_outputs['labels'] == label
                ])

            plt.figure(figsize=(15, 15))
            for i, cluster in enumerate(indiv_clusters):
                scatter = plt.scatter(
                    cluster[:, :1],
                    cluster[:, 1:],
                    color=plt.cm.get_cmap(
                        'hsv', cluster_outputs['num_clusters']+1)(i),
                    alpha=0.6,
                    label=i,
                    s=200,
                )
            plt.xlabel('Dimension 1')
            plt.ylabel('Dimension 2')
            plt.title('tSNE Results: Sentence Embeddings')
            plt.legend(title='Clustering Labels')
            plt.show()
            print('\n')

        if method == 'pca':
            pca = PCA(n_components=dims)
            projected_embeddings = np.array(pca.fit_transform(self.embeddings))

            cluster_outputs = self.cluster_outputs()

            indiv_clusters = []
            for label in range(cluster_outputs['num_clusters']):
                indiv_clusters.append(projected_embeddings[
                    cluster_outputs['labels'] == label
                ])

            plt.figure(figsize=(15, 15))
            for i, cluster in enumerate(indiv_clusters):
                scatter = plt.scatter(
                    cluster[:, :1],
                    cluster[:, 1:],
                    color=plt.cm.get_cmap(
                        'hsv', cluster_outputs['num_clusters']+1)(i),
                    alpha=0.6,
                    label=i,
                    s=200,
                )
            plt.xlabel('Dimension 1')
            plt.ylabel('Dimension 2')
            plt.title('PCA Results: Sentence Embeddings')
            plt.legend(title='Clustering Labels')
            plt.show()
            print('\n')

        return None

    def get_clusters(self):
        return


articles = [
    """Bitcoin, Ethereum and a host of Altcoins suffered massive drops Tuesday night and Wednesday morning, erasing months of gains and hundreds of billions in market cap. The overall crypto market shrunk more than 20% over the past 24 hours according to crypto tracker CoinMarketCap. What’s behind the drop? Well, some may say the market was flying too close to the sun as investors piled into speculative and technically unremarkable projects like Dogecoin. Others may pin the blame on Elon Musk, who announced that Tesla would no longer be accepting bitcoin for Tesla purchases, which investors feared could trigger a broader backlash among corporate adopters who they hoped would be encouraged to put bitcoin on their balance sheets. Not all cryptocurrencies are seeing the same fortune, while Bitcoin dropped to nearly $31K, more than half its all-time-high, Ethereum fell to prices it first reached last month. Some of the steepest losses were seen by Dfinity’s Internet Computer token, which has shed nearly 60% of its value in the past week. Meanwhile, multi-chain development platform Polygon has surged throughout the broader crash, up 88% this week. Public market investors got a taste for the crypto market’s volatility as Coinbase stock fell 5% Wednesday morning, down more than 47% from its briefly achieved all-time high and 10% lower than its direct listing target price.""",
    """The value of the most well-known cryptocurrency has plunged by nearly 30% after a massive rise in value. Here’s what you need to know What is bitcoin? Bitcoin is the world’s most popular digital currency. It allows people to bypass banks and traditional payment methods and is not controlled by any single entity, country or central bank. There are more than 18m bitcoins in existence. What do its backers say about it? Some supporters believe bitcoin could eventually replace fiat (government-issued) currencies thanks to the growing popularity of digital payments. Others also say it is protected from manipulation by governments and central banks, offering a more democratic payment system. Meanwhile, investors believe it can provide a hedge against inflation, and analysts at JP Morgan have even likened it to haven assets such as gold. What do its critics say? Sceptics claim that bitcoin has no intrinsic value and say it poses a risk for investors, who are not protected by regulators or financial protection schemes if the asset tanks. Critics also warn that investors could be exposing themselves to fraud, since cryptocurrencies like bitcoin have been linked to money laundering and black market dealings. There are also concerns about the environmental impact of bitcoin “mining”, which requires energy-intensive computers to generate coins. How well has it been doing recently? Advertisement Bitcoin made significant gains at the start of 2021. By mid-April, it hit all-time highs of more than $64,000 per unit, jumping more than 450% in just six months. Its meteoric rise in value has sparked further interest from institutional investors and major banks like Goldman Sachs, which set up its bitcoin trading desk earlier this month. Why is it crashing today? Bitcoin’s price plunged by nearly 30% to almost $30,000 (£21,000) on Wednesday after Chinese regulators announced that they were banning banks and payment firms from using cryptocurrencies. But the selloff started last week after the Tesla founder suspended plans to let customers pay in bitcoin. Elon Musk, who is seen as a staunch supporter of cryptocurrencies, was also caught in a confusing exchange on Twitter about plans for Tesla’s bitcoin holdings that spooked investors.""",
    """Bitcoin plunged 30% to near $30,000 at one point on Wednesday, continuing a major sell-off in the cryptocurrency markets that began a week ago. The digital currency hit as low as $30,001.51 as the selling intensified Wednesday before paring some of those losses. The cryptocurrency hasn’t traded at those levels since late January. Bitcoin rebounded as the day went on, was down 12% to about $38,205.49 shortly after 3 p.m. ET. At its intraday low, the cryptocurrency’s loss for the past week was more than 40%. Bitcoin plunged 30% to near $30,000 at one point on Wednesday, continuing a major sell-off in the cryptocurrency markets that began a week ago. The digital currency hit as low as $30,001.51 as the selling intensified Wednesday before paring some of those losses. The cryptocurrency hasn’t traded at those levels since late January. Bitcoin rebounded as the day went on, was down 12% to about $38,205.49 shortly after 3 p.m. ET. At its intraday low, the cryptocurrency’s loss for the past week was more than 40% Negative news over the past week has dampened sentiment for bitcoin. On May 12, Musk said the electric carmaker had suspended vehicle purchases using bitcoin, citing environmental concerns over the so-called computational “mining” process. This is where high-powered computers are used to solve complex mathematical puzzles to enable transactions using bitcoin. Musk’s comments caused over $300 billion to be wiped off the entire cryptocurrency market that day. Musk did suggest on Wednesday that the automaker was not selling its existing bitcoin, saying with emojis on Twitter that Tesla has “diamond hands.” That tweet was published near bitcoin’s lows for the day.""",
]

articles = np.array(articles)

sentences, words = make_data(articles)
embeddings = sentence2embedding(sentences, embedding_model)

print(sentences.shape, words.shape)
print(embeddings.shape)


CLEMB_KWARGS = {
    'clustering_algorithm': AgglomerativeClustering(
        n_clusters=None,
        distance_threshold=7
    ),
    'embeddings': embeddings,
    'sentences': sentences,
    'words': words,
    'num_articles': len(articles)
}

clemb = ClusterSentenceEmbeddings(**CLEMB_KWARGS)

print(clemb.cluster_outputs()['num_clusters'])
print(clemb.cluster_outputs()['exp_sentences_per_cluster'])
print(clemb.cluster_outputs()['exp_words_per_cluster'])

clemb.visualize_outputs()

clemb.visualize_outputs(method='pca')
